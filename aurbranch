#!/bin/bash

# Compose resources in a temporary directory.
tmpdir="$(mktemp -d --tmpdir aurbranch.XXXXXXXXXX)"
trap "rm -r '$tmpdir'" EXIT

export GIT_INDEX_FILE="$tmpdir/index"

srcinfo="$tmpdir/srcinfo"
mksrcinfo -o "$srcinfo"
pkgbase=$(grep -Po '(?<=pkgbase = ).*' "$srcinfo")

# Compose new revision.
# add <file> to the index at <location>. Without the latter, the file
# is placed as if it was rooted at the current working directory.
add() {
  git update-index --add --cacheinfo \
    $(stat -c '%a' $1),$(git hash-object --path "${2:-$1}" -w "$1"),"${2:-$1}"
}
add "$srcinfo" .SRCINFO
add PKGBUILD

# Commit, if necessary.
if git show-ref --verify --quiet "refs/heads/aur/$pkgbase"
then
  if ! git diff-index --cached --quiet "aur/$pkgbase" --
  then
    git update-ref "refs/heads/aur/$pkgbase" $(\
      git commit-tree $(git write-tree) \
      -m "update AUR distribution branch" \
      -p "aur/$pkgbase")
  fi
else
  git update-ref "refs/heads/aur/$pkgbase" $(\
    git commit-tree $(git write-tree) \
    -m "create AUR distribution branch")
fi
